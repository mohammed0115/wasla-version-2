{% extends "base.html" %}
{% load static i18n %}
{% block title %}{% trans "Verify" %}{% endblock %}
{% block global_lang_switcher %}{% endblock %}
{% block extra_css %}
<style>
  .otp-header {
    text-align: center;
    margin-top: 8px;
  }

  .otp-title {
    margin: 0;
    font-weight: 900;
  }

  .otp-subtitle {
    margin-top: 6px;
  }

  .otp-form {
    margin-top: 18px;
  }

  .otp-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 10px;
  }

  .otp-grid input {
    min-height: 52px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--white);
    color: var(--text);
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    outline: none;
  }

  .otp-grid input:focus {
    border-color: var(--primary);
  }

  .otp-flash,
  .otp-errors {
    margin-top: 10px;
  }

  .otp-flash-item,
  .otp-error-item {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
  }

  .otp-flash-item.error,
  .otp-error-item {
    color: var(--accent);
  }

  .otp-links {
    margin-top: 14px;
    text-align: center;
  }

  .otp-logout {
    color: var(--accent);
  }

  @media (max-width: 560px) {
    .otp-grid {
      gap: 8px;
    }

    .otp-grid input {
      min-height: 48px;
    }
  }
</style>
{% endblock %}
{% block body %}
<div class="auth-shell">
  <div class="card auth-card stack-24">
    <div class="auth-header">
      <form action="{% url 'set_language' %}" method="post" style="display:inline;">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.get_full_path }}">
        {% get_current_language as LANGUAGE_CODE %}
        {% if LANGUAGE_CODE == 'ar' %}
          <input type="hidden" name="language" value="en">
          <button class="btn btn-soft" type="submit">English</button>
        {% else %}
          <input type="hidden" name="language" value="ar">
          <button class="btn btn-soft" type="submit">العربية</button>
        {% endif %}
      </form>
      <img class="auth-logo" src="{% static 'images/logo.jpeg' %}" alt="Wasla">
    </div>

    <div class="otp-header">
      <h2 class="otp-title">{% trans "Enter verification code" %}</h2>
      <div class="muted otp-subtitle">{% trans "We sent a code to" %} {{ masked_email }}</div>

      {% if messages %}
        <div class="stack-8 otp-flash">
          {% for message in messages %}
            <div class="otp-flash-item {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" class="otp-form">
        {% csrf_token %}
        <div class="otp-grid salla-otp">
          {{ form.d1.as_widget }}
          {{ form.d2.as_widget }}
          {{ form.d3.as_widget }}
          {{ form.d4.as_widget }}
        </div>

        {% if form.non_field_errors %}
          <div class="stack-8 otp-errors">
            {% for e in form.non_field_errors %}
              <div class="otp-error-item">{{ e }}</div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="otp-links">
          <a href="{% url 'accounts:logout' %}" class="otp-logout">{% trans "Logout" %}</a>
          <span class="muted"> | </span>
          <a href="{% url 'accounts:resend_otp' %}">{% trans "Resend" %}</a>
        </div>

        <button class="btn btn-primary btn-block" type="submit">{% trans "Verify" %}</button>
      </form>
    </div>
  </div>
</div>

<script>
  // auto move focus
  const inputs = Array.from(document.querySelectorAll(".salla-otp input"));
  inputs.forEach((inp, idx) => {
    inp.addEventListener("input", () => {
      if (inp.value && idx < inputs.length-1) inputs[idx+1].focus();
    });
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !inp.value && idx>0) inputs[idx-1].focus();
    });
  });
  if (inputs[0]) inputs[0].focus();
</script>
{% endblock %}
