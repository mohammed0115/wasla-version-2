{% extends "base.html" %}
{% block title %}النشاط التجاري{% endblock %}
{% block body %}
<div class="salla-shell" dir="rtl">
  <div class="salla-card">
    <div style="text-align:right;margin-bottom:8px">
      <a href="{% url 'accounts:persona_channel' %}" class="salla-lang" style="text-decoration:none">السؤال السابق</a>
    </div>

    <h2 style="text-align:center;margin:10px 0 6px;font-weight:900">أخيراً، ما هو نشاطك التجاري؟</h2>
    <div class="muted" style="text-align:center;margin-bottom:12px">
      اختر المنتجات والخدمات التي تخطط لبيعها.
    </div>

    <form method="post" id="catForm">
      {% csrf_token %}
      <input type="hidden" name="category_main" id="catMain" value="{{ form.initial.category_main|default:'' }}">
      <input type="hidden" name="category_sub" id="catSub" value="{{ form.initial.category_sub|default:'' }}">

      <div class="salla-pill-wrap" id="mainPills">
        {% for val,label in form.fields.category_main.choices %}
          <button type="button" class="salla-pill" data-main="{{val}}">{{ label }}</button>
        {% endfor %}
      </div>

      <div id="subSection" style="display:none;margin-top:18px">
        <h3 style="text-align:center;margin:6px 0 10px;font-weight:900">اختر تصنيفاً فرعياً</h3>
        <div class="salla-pill-wrap" id="subPills"></div>
      </div>

      <button class="salla-primary" type="submit" id="startBtn" style="max-width:520px;display:none">ابدأ تجهيز متجرك</button>
    </form>
  </div>
</div>

<script>
  const SUBS = {{ subs_json|safe }};
  const mainPills = Array.from(document.querySelectorAll("#mainPills .salla-pill"));
  const subSection = document.getElementById("subSection");
  const subPills = document.getElementById("subPills");
  const catMain = document.getElementById("catMain");
  const catSub = document.getElementById("catSub");
  const startBtn = document.getElementById("startBtn");

  function setActive(btns, predicate){
    btns.forEach(b => b.classList.toggle("active", predicate(b)));
  }

  function renderSubs(main){
    subPills.innerHTML = "";
    const subs = SUBS[main] || [];
    if (!subs.length){
      subSection.style.display = "none";
      catSub.value = "";
      startBtn.style.display = "block";
      return;
    }
    subSection.style.display = "block";
    startBtn.style.display = "none";
    subs.forEach(([val,label]) => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "salla-pill";
      b.textContent = label;
      b.dataset.sub = val;
      b.addEventListener("click", () => {
        catSub.value = val;
        setActive(Array.from(subPills.querySelectorAll(".salla-pill")), x => x.dataset.sub === val);
        startBtn.style.display = "block";
      });
      subPills.appendChild(b);
    });
  }

  mainPills.forEach(b => {
    b.addEventListener("click", () => {
      const main = b.dataset.main;
      catMain.value = main;
      setActive(mainPills, x => x.dataset.main === main);
      renderSubs(main);
    });
  });

  // init from initial values
  if (catMain.value){
    setActive(mainPills, x => x.dataset.main === catMain.value);
    renderSubs(catMain.value);
    if (catSub.value){
      setTimeout(()=> {
        setActive(Array.from(subPills.querySelectorAll(".salla-pill")), x => x.dataset.sub === catSub.value);
        startBtn.style.display = "block";
      }, 0);
    }
  }
</script>
{% endblock %}
