{% extends "dashboard/_base.html" %}
{% load static %}
{% block page_title %}البحث بالصورة{% endblock %}
{% block page_subtitle %}ارفع صورة وسيقوم النظام باقتراح منتجات مشابهة مع فلاتر سريعة (12/24 نتيجة).{% endblock %}

{% block content %}
<style>
  .vs-layout{display:grid; grid-template-columns: 340px 1fr; gap:14px;}
  @media (max-width: 980px){ .vs-layout{grid-template-columns: 1fr;} }
  .vs-card{padding:14px;}
  .vs-grid{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px;}
  @media (max-width: 1200px){ .vs-grid{grid-template-columns: repeat(3, minmax(0, 1fr));} }
  @media (max-width: 820px){ .vs-grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
  .vs-item{padding:12px;}
  .vs-skel{border-radius:16px; background:#f1f5f9; height:220px; animation:pulse 1.1s infinite;}
  @keyframes pulse{0%{opacity:.55}50%{opacity:.95}100%{opacity:.55}}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#f1f5f9; font-weight:700; font-size:12px; color:#334155;}
</style>

<div class="vs-layout">
  <!-- Sidebar -->
  <div class="card vs-card">
    <div class="kicker">فلاتر البحث</div>
    <h2 style="margin:6px 0 0; font-size:18px;">خيارات النتائج</h2>

    <form id="vsForm" data-endpoint="/api/ai/visual-search" style="display:grid; gap:10px; margin-top:12px;">
      {% csrf_token %}

      <label class="muted" style="font-weight:800;">الصورة</label>
      <input required name="image" type="file" accept="image/*" class="form-control" />

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label class="muted" style="font-weight:800;">عدد النتائج</label>
          <select name="top_n" class="form-control">
            <option value="12">12</option>
            <option value="24">24</option>
          </select>
        </div>
        <div>
          <label class="muted" style="font-weight:800;">لون</label>
          <select name="color" class="form-control">
            <option value="">الكل</option>
            <option value="red">أحمر</option>
            <option value="orange">برتقالي</option>
            <option value="yellow">أصفر</option>
            <option value="green">أخضر</option>
            <option value="cyan">سماوي</option>
            <option value="blue">أزرق</option>
          </select>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label class="muted" style="font-weight:800;">السعر من</label>
          <input name="price_min" type="number" step="1" min="0" class="form-control" placeholder="0" />
        </div>
        <div>
          <label class="muted" style="font-weight:800;">السعر إلى</label>
          <input name="price_max" type="number" step="1" min="0" class="form-control" placeholder="1000" />
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label class="muted" style="font-weight:800;">الإضاءة</label>
          <select name="brightness" class="form-control">
            <option value="">الكل</option>
            <option value="dark">غامق</option>
            <option value="normal">عادي</option>
            <option value="bright">فاتح</option>
          </select>
        </div>
        <div>
          <label class="muted" style="font-weight:800;">خلفية بيضاء</label>
          <select name="white_background" class="form-control">
            <option value="">الكل</option>
            <option value="true">نعم</option>
            <option value="false">لا</option>
          </select>
        </div>
      </div>

      <details style="margin-top:6px;">
        <summary class="muted" style="font-weight:900; cursor:pointer;">فلاتر متقدمة (اختياري)</summary>
        <div style="display:grid; gap:10px; margin-top:10px;">
          <div>
            <label class="muted" style="font-weight:800;">Category</label>
            <input name="category" class="form-control" placeholder="shoes / dress ..." />
          </div>
          <div>
            <label class="muted" style="font-weight:800;">Material</label>
            <input name="material" class="form-control" placeholder="leather / cotton ..." />
          </div>
          <div>
            <label class="muted" style="font-weight:800;">Style</label>
            <input name="style" class="form-control" placeholder="formal / casual ..." />
          </div>
        </div>
      </details>

      <button class="btn" type="submit" style="margin-top:8px;">بحث الآن</button>

      <hr style="margin:10px 0; opacity:.15">

      <div class="muted" style="font-weight:800;">إدارة الفهرس</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-soft" id="vsIndexBtn" type="button" data-endpoint="/api/ai/index-products">بناء/تحديث الفهرس</button>
        <label class="muted" style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="vsForce" /> Force
        </label>
      </div>

      <div id="vsMeta" class="muted" style="white-space:pre-wrap; margin-top:10px;"></div>
    </form>
  </div>

  <!-- Main -->
  <div class="card vs-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 style="margin:0; font-size:18px;">النتائج</h2>
        <div class="muted" style="margin-top:6px;">سيتم عرض النتائج هنا بعد رفع الصورة.</div>
      </div>
      <button class="btn btn-soft" id="vsLoadMore" type="button" style="display:none;">تحميل المزيد</button>
    </div>

    <div id="vsQueryAttrs" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;"></div>

    <div id="vsSkeleton" style="display:none; margin-top:12px;" class="vs-grid">
      {% for _ in "123456789012" %}
        <div class="vs-skel"></div>
      {% endfor %}
    </div>

    <div id="vsResults" class="vs-grid" style="margin-top:12px;"></div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById("vsForm");
  const resultsGrid = document.getElementById("vsResults");
  const metaBox = document.getElementById("vsMeta");
  const skel = document.getElementById("vsSkeleton");
  const loadMore = document.getElementById("vsLoadMore");
  const qAttrs = document.getElementById("vsQueryAttrs");
  const indexBtn = document.getElementById("vsIndexBtn");
  const forceChk = document.getElementById("vsForce");

  let lastItems = [];
  let shown = 0;

  function setMeta(obj){
    metaBox.textContent = obj ? JSON.stringify(obj, null, 2) : "";
  }

  function renderAttrs(attrs){
    qAttrs.innerHTML = "";
    if(!attrs) return;
    Object.entries(attrs).forEach(([k,v])=>{
      if(v === null || v === undefined || v === "") return;
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = `${k}: ${typeof v === "object" ? JSON.stringify(v) : v}`;
      qAttrs.appendChild(span);
    });
  }

  function render(items, append=false){
    if(!append){
      resultsGrid.innerHTML = "";
      shown = 0;
    }
    const step = 12;
    const next = items.slice(shown, shown + step);
    next.forEach(it => {
      const card = document.createElement("div");
      card.className = "card vs-item";
      card.innerHTML = `
        <div style="height:150px;border-radius:14px;background:#f8fafc;overflow:hidden;display:flex;align-items:center;justify-content:center">
          ${it.image ? `<img src="${it.image}" style="width:100%;height:100%;object-fit:cover">` : `<div class="muted">No image</div>`}
        </div>
        <div style="margin-top:10px;font-weight:900; font-size:14px; line-height:1.2">${it.name || ("#" + it.product_id)}</div>
        <div class="muted" style="display:flex;justify-content:space-between;margin-top:6px; gap:10px;">
          <span>Match: ${(Number(it.score||0)*100).toFixed(1)}%</span>
          <span>${it.price ? (it.price + " SAR") : ""}</span>
        </div>
      `;
      resultsGrid.appendChild(card);
    });
    shown += next.length;
    loadMore.style.display = shown < items.length ? "inline-flex" : "none";
  }

  if(loadMore){
    loadMore.addEventListener("click", ()=> render(lastItems, true));
  }

  if(indexBtn){
    indexBtn.addEventListener("click", async ()=>{
      setMeta({status:"indexing..."});
      const fd = new FormData();
      if(forceChk && forceChk.checked) fd.append("force", "true");
      try{
        const res = await fetch(indexBtn.dataset.endpoint, {method:"POST", body:fd});
        const data = await res.json();
        setMeta({index_products:data});
      }catch(e){
        setMeta({error:String(e)});
      }
    });
  }

  if(form){
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      if(skel) skel.style.display = "grid";
      resultsGrid.innerHTML = "";
      renderAttrs(null);
      setMeta({status:"searching..."});
      try{
        const res = await fetch(form.dataset.endpoint, {method:"POST", body:fd});
        const data = await res.json();
        if(skel) skel.style.display = "none";

        renderAttrs(data.query_attributes || null);
        setMeta({
          provider: data.provider,
          count: (data.results||[]).length,
          warnings: data.warnings || [],
        });

        lastItems = data.results || [];
        render(lastItems, false);
      }catch(err){
        if(skel) skel.style.display = "none";
        setMeta({error: String(err)});
      }
    });
  }
})();
</script>
{% endblock %}
