{% extends "base.html" %}
{% load static i18n %}
{% block title %}{% trans "Plans" %}{% endblock %}
{% block body %}
<div class="salla-shell">
  <div class="salla-card" style="width:min(1100px,100%)">
    <div style="text-align:center;margin-bottom:12px">
      <div style="display:inline-block;background:rgba(105,230,211,.65);padding:10px 16px;border-radius:999px;font-weight:900">
        {% trans "Join over" %} <span style="font-weight:900">68,000</span> {% trans "active merchants on Wasla" %}
      </div>
    </div>

    <h1 style="text-align:center;margin:10px 0 14px;font-weight:900">{% trans "Choose the best plan for your business growth" %}</h1>

    <div class="plan-toggle" role="tablist" aria-label="billing cycle">
      <button type="button" id="btnYear" class="{% if billing_cycle == 'yearly' %}active{% endif %}">{% trans "Yearly" %}</button>
      <button type="button" id="btnMonth" class="{% if billing_cycle != 'yearly' %}active{% endif %}">{% trans "Monthly" %}</button>
    </div>

    <form method="post" id="planForm">
      {% csrf_token %}
      <input type="hidden" name="billing_cycle" id="billingCycle" value="{{ billing_cycle|default:'monthly' }}">
      <input type="hidden" name="plan_id" id="planId" value="{{ selected_plan_id|default:'' }}">

      <div class="plan-grid">
        {% for p in plans %}
          {% if p.is_free %}
            <div class="plan-card" style="background:rgba(105,230,211,.25)">
              <div style="font-weight:900;font-size:18px">{% trans "Wasla Basic" %}</div>
              <div class="muted" style="margin-top:6px">{% trans "For getting started" %}</div>
              <div class="price" data-month...>{% trans "Free" %}</div>
              <button type="button" onclick="selectPlan('{{p.id}}')">{% trans "Choose Basic" %}</button>
            </div>
          {% elif p.is_popular %}
            <div class="plan-card popular">
              <div class="plan-badge">الأنسب لتجارتك</div>
              <div style="font-weight:900...">{% trans "Wasla Plus" %}</div>
              <div class="muted" style="margin-top:6px">{% trans "For individual merchants and families" %}</div>
              <div class="price" data-month="{{p.price_monthly}}" data-year="{{p.price_yearly}}">
                <span class="num"></span>
                <span style="font-size:14px;font-weight:800">{% trans "SAR / month" %}</span>
              </div>
              <button type="button" onclick="selectPlan('{{p.id}}')">{% trans "Choose Plus" %}</button>
            </div>
          {% else %}
            <div class="plan-card dark">
              <div style="font-weight:900...">{% trans "Wasla Pro" %}</div>
              <div class="muted" style="margin-top:6px;color:rgba(255,255,255,.8)">{% trans "For companies and institutions" %}</div>
              <div class="price" data-month="{{p.price_monthly}}" data-year="{{p.price_yearly}}">
                <span class="num"></span>
                <span style="font-size:14px;font-weight:800">{% trans "SAR / month" %}</span>
              </div>
              <button type="button" onclick="selectPlan('{{p.id}}')">{% trans "Choose Pro" %}</button>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="compare-actions">
        <button type="button" id="toggleCompare">{% trans "Compare plans" %}</button>
      </div>

      <div id="compareBox" class="compare-table" style="display:none">
        <!-- simplified features table (MVP) -->
        <div class="compare-row" style="background:#f8fafc;font-weight:900">
          <div>{% trans "Pro" %}</div><div>{% trans "Plus" %}</div><div>{% trans "Basic" %}</div><div class="feat">{% trans "Feature" %}</div>
        </div>
        {% for feat in compare_features %}
        <div class="compare-row">
          <div class="{% if feat.pro %}yes{% else %}no{% endif %}">{% if feat.pro %}✓{% else %}×{% endif %}</div>
          <div class="{% if feat.plus %}yes{% else %}no{% endif %}">{% if feat.plus %}✓{% else %}×{% endif %}</div>
          <div class="{% if feat.basic %}yes{% else %}no{% endif %}">{% if feat.basic %}✓{% else %}×{% endif %}</div>
          <div class="feat">{{ feat.name }}</div>
        </div>
        {% endfor %}
      </div>
    </form>
  </div>
</div>

<script>
  const cycleInput = document.getElementById("billingCycle");
  const btnMonth = document.getElementById("btnMonth");
  const btnYear = document.getElementById("btnYear");
  const compareBox = document.getElementById("compareBox");
  const toggleCompare = document.getElementById("toggleCompare");

  const FREE_LABEL = "{% trans 'Free' %}";

  function formatPrice(val){
    // show as integer if possible
    const n = parseFloat(val);
    if (!isFinite(n) || n <= 0) return FREE_LABEL;
    return n.toFixed(0);
  }
  function refreshPrices(){
    const yearly = cycleInput.value === "yearly";
    document.querySelectorAll(".price").forEach(el => {
      if (el.textContent.includes(FREE_LABEL)) return;
      const v = yearly ? el.dataset.year : el.dataset.month;
      const num = el.querySelector(".num");
      if (num) num.textContent = formatPrice(v);
    });
  }
  btnMonth.addEventListener("click", ()=>{ cycleInput.value="monthly"; btnMonth.classList.add("active"); btnYear.classList.remove("active"); refreshPrices(); });
  btnYear.addEventListener("click", ()=>{ cycleInput.value="yearly"; btnYear.classList.add("active"); btnMonth.classList.remove("active"); refreshPrices(); });

  toggleCompare.addEventListener("click", ()=>{
    const isOpen = compareBox.style.display !== "none";
    compareBox.style.display = isOpen ? "none" : "block";
    toggleCompare.textContent = isOpen ? "مقارنة الباقات" : "إخفاء المقارنة";
  });

  function selectPlan(id){
    document.getElementById("planId").value = id;
    document.getElementById("planForm").submit();
  }

  refreshPrices();
</script>
{% endblock %}
