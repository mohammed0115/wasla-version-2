{% extends "base.html" %}

{% block title %}Visual Search{% endblock %}

{% block extra_css %}
<style>
  :root {
    --wasla-primary: #C9A227;
    --wasla-secondary: #0A1628;
    --wasla-accent: #1E3A5F;
  }
  .vs-wrapper { max-width: 1200px; margin: 1.5rem auto; padding: 0 1rem; }
  .vs-card { background: #fff; border: 1px solid #e7e7e7; border-radius: 14px; padding: 1rem; }
  .vs-title { color: var(--wasla-secondary); margin: 0 0 .5rem; }
  .vs-uploader { border: 2px dashed var(--wasla-accent); border-radius: 12px; padding: 1rem; text-align: center; }
  .vs-uploader.dragover { background: #f5f8fd; }
  .vs-filters { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: .75rem; margin-top: .75rem; }
  .vs-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; margin-top: 1rem; }
  .vs-item { border: 1px solid #ececec; border-radius: 12px; padding: .75rem; background: #fff; }
  .vs-item img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; background: #f3f3f3; }
  .vs-pill { color: #fff; background: var(--wasla-accent); border-radius: 999px; padding: .2rem .6rem; font-size: .8rem; }
  .vs-actions { margin-top: .75rem; display: flex; gap: .5rem; flex-wrap: wrap; }
  .vs-btn { border: 0; border-radius: 10px; padding: .6rem .9rem; cursor: pointer; }
  .vs-btn-primary { background: var(--wasla-primary); color: #111; font-weight: 600; }
  .vs-btn-dark { background: var(--wasla-secondary); color: #fff; }
  .vs-error { color: #b00020; margin-top: .5rem; }
  .vs-empty { margin-top: 1rem; border: 1px dashed #d8d8d8; border-radius: 10px; padding: 1rem; color: #555; }
  .vs-spinner { display: none; margin-top: .5rem; }
  .vs-spinner.active { display: inline-block; }
  @media (max-width: 768px) { .vs-filters { grid-template-columns: 1fr 1fr; } }
</style>
{% endblock %}

{% block body %}
<div class="vs-wrapper">
  <div class="vs-card">
    <h1 class="vs-title">Visual Search Engine</h1>
    <form method="post" enctype="multipart/form-data" id="visual-search-form">
      {% csrf_token %}

      <div class="vs-uploader" id="dropzone">
        <p>Upload product image or drag & drop</p>
        <input type="file" name="image_file" id="image_file" accept="image/jpeg,image/png,image/webp">
        <p style="margin-top:.5rem;">or</p>
        <input type="url" name="image_url" placeholder="https://example.com/product.jpg" style="width:100%; max-width:520px;">
      </div>

      <div class="vs-filters">
        <input type="number" step="0.01" name="min_price" placeholder="Min price" value="{{ min_price }}">
        <input type="number" step="0.01" name="max_price" placeholder="Max price" value="{{ max_price }}">
        <select name="sort_by">
          <option value="similarity" {% if sort_by == 'similarity' %}selected{% endif %}>Sort by similarity</option>
          <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Price low to high</option>
          <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Price high to low</option>
        </select>
        <div class="vs-actions">
          <button class="vs-btn vs-btn-primary" type="submit">Search</button>
          <button class="vs-btn vs-btn-dark" type="reset">Reset</button>
        </div>
      </div>

      <div id="spinner" class="vs-spinner" aria-live="polite">Searching...</div>
      {% if error_message %}
      <p class="vs-error">{{ error_message }}</p>
      {% endif %}
    </form>

    {% if results %}
      <div class="vs-results">
        {% for item in results %}
          <article class="vs-item">
            {% if item.image_url %}
              <img src="{{ item.image_url }}" alt="{{ item.title }}">
            {% else %}
              <img alt="No image available">
            {% endif %}
            <h3>{{ item.title }}</h3>
            <p>{{ item.price }} SAR</p>
            <span class="vs-pill">Similarity {{ item.similarity_score|floatformat:3 }}</span>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="vs-empty">No results yet. Upload an image to start visual search.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const form = document.getElementById('visual-search-form');
    const spinner = document.getElementById('spinner');
    const dropzone = document.getElementById('dropzone');
    const input = document.getElementById('image_file');

    form.addEventListener('submit', function () {
      spinner.classList.add('active');
    });

    ['dragenter', 'dragover'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, function (event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, function (event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', function (event) {
      if (!event.dataTransfer || !event.dataTransfer.files || !event.dataTransfer.files.length) {
        return;
      }
      input.files = event.dataTransfer.files;
    });
  })();
</script>
{% endblock %}
