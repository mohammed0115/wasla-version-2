{% extends "base.html" %}
{% load static %}

{% block title %}Visual Search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visual_search.css' %}">
{% endblock %}

{% block body %}
<div class="vs-shell">
  <div class="vs-card">
    <h1 class="vs-title">Visual Search Engine</h1>
    <form method="post" enctype="multipart/form-data" id="visual-search-form">
      {% csrf_token %}

      <div class="vs-dropzone" id="vs-dropzone">
        <p class="vs-uploader-text">Upload product image or drag & drop</p>
        <input class="vs-input" type="file" name="image_file" id="image_file" accept="image/jpeg,image/png,image/webp">
        <p class="vs-or">or</p>
        <input class="vs-input" type="url" name="image_url" value="{{ image_url }}" placeholder="https://example.com/product.jpg">
      </div>

      <div class="vs-filters">
        <input class="vs-input" type="number" step="0.01" name="min_price" placeholder="Min price" value="{{ min_price }}">
        <input class="vs-input" type="number" step="0.01" name="max_price" placeholder="Max price" value="{{ max_price }}">
        <select class="vs-input" name="sort_by">
          <option value="similarity" {% if sort_by == 'similarity' %}selected{% endif %}>Sort by similarity</option>
          <option value="price_low" {% if sort_by == 'price_low' or sort_by == 'price_asc' %}selected{% endif %}>Price low to high</option>
          <option value="price_high" {% if sort_by == 'price_high' or sort_by == 'price_desc' %}selected{% endif %}>Price high to low</option>
          <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest</option>
        </select>
        <select class="vs-input" name="max_results">
          <option value="12" {% if max_results == '12' %}selected{% endif %}>12</option>
          <option value="24" {% if max_results == '24' %}selected{% endif %}>24</option>
          <option value="48" {% if max_results == '48' %}selected{% endif %}>48</option>
        </select>
        <div class="vs-actions">
          <button class="vs-btn vs-btn-primary" type="submit">Search</button>
          <a class="vs-btn vs-btn-dark" href="{% url 'visual_search:visual_search' %}">Reset</a>
        </div>
      </div>

      <div id="spinner" class="vs-spinner" aria-live="polite">
        <span class="vs-spinner-dot" aria-hidden="true"></span>
        <span>Searching for similar products...</span>
      </div>
      {% if info_message %}
      <p class="vs-info">{{ info_message }}</p>
      {% endif %}
      {% if error_message %}
      <p class="vs-error">{{ error_message }}</p>
      {% endif %}
    </form>

    {% if attributes %}
      <div class="vs-attrs">
        {% for key, value in attributes.items %}
          <span class="vs-attr">{{ key }}: {{ value }}</span>
        {% endfor %}
      </div>
    {% endif %}

    {% if results %}
      <div class="vs-grid">
        {% for item in results %}
          <article class="vs-item">
            {% if request.tenant and request.tenant.slug %}
              <a class="vs-item-link" href="{% url 'cart_web:product_detail' store_slug=request.tenant.slug product_id=item.product_id %}">
                {% if item.image_url %}
                  <img src="{{ item.image_url }}" alt="{{ item.title }}">
                {% else %}
                  <div class="vs-no-image">No image available</div>
                {% endif %}
                <h3>{{ item.title }}</h3>
                <p>{{ item.price }} {{ item.currency }}</p>
                <span class="vs-pill">Similarity {{ item.similarity_score|floatformat:3 }}</span>
              </a>
            {% else %}
              <div class="vs-item-link">
                {% if item.image_url %}
                  <img src="{{ item.image_url }}" alt="{{ item.title }}">
                {% else %}
                  <div class="vs-no-image">No image available</div>
                {% endif %}
                <h3>{{ item.title }}</h3>
                <p>{{ item.price }} {{ item.currency }}</p>
                <span class="vs-pill">Similarity {{ item.similarity_score|floatformat:3 }}</span>
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% elif has_searched and not error_message %}
      <div class="vs-empty">No matching products yet. Try another image, URL, or adjust your filters.</div>
    {% else %}
      <div class="vs-empty">Start by uploading an image or adding an image URL to discover similar products.</div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const form = document.getElementById('visual-search-form');
    const spinner = document.getElementById('spinner');
    const dropzone = document.getElementById('vs-dropzone');
    const input = document.getElementById('image_file');

    form.addEventListener('submit', function () {
      spinner.classList.add('active');
    });

    ['dragenter', 'dragover'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, function (event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'drop'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, function (event) {
        event.preventDefault();
        event.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', function (event) {
      if (!event.dataTransfer || !event.dataTransfer.files || !event.dataTransfer.files.length) {
        return;
      }
      input.files = event.dataTransfer.files;
    });
  })();
</script>
{% endblock %}
